!function(f){function n(e){var t=0<e.find(".fs-option:not(.hidden)").length;e.find(".fs-no-results").toggleClass("hidden",t)}function l(e){e.find(".fs-option.hl").removeClass("hl"),e.find(".fs-search input").focus(),window.fSelect.idx=-1}function o(e){var t=e.find(".fs-options"),i=e.find(".fs-option.hl"),s=i.offset().top+t.scrollTop(),n=s+i.outerHeight(),l=t.offset().top+t.scrollTop(),o=l+t.outerHeight();if(o<n){var a=t.scrollTop()+n-o;t.scrollTop(a)}else if(s<l){a=t.scrollTop()-l-s;t.scrollTop(a)}}function c(e){if(void 0===e&&null!=window.fSelect.active_el&&(e=window.fSelect.active_el),void 0!==e){var t=window.fSelect.initial_values,i=e.find("select").val();JSON.stringify(t)!=JSON.stringify(i)&&f(document).trigger("fs:closed",e)}f(".fs-wrap").removeClass("fs-open"),f(".fs-dropdown").addClass("hidden"),window.fSelect.active_el=null,window.fSelect.active_id=null,window.fSelect.last_choice=null}f.fn.fSelect=function(e){if("string"==typeof e)var t=e;else t=f.extend({placeholder:"Select some options",numDisplayed:3,overflowText:"{n} selected",searchText:"Search",noResultsText:"No results found",showSearch:!0,optionFormatter:!1},e);function i(e,t){this.$select=f(e),this.settings=t,this.create()}return i.prototype={create:function(){this.settings.multiple=this.$select.is("[multiple]");var e=this.settings.multiple?" multiple":"";this.$select.wrap('<div class="fs-wrap'+e+'" tabindex="0" />'),this.$select.before('<div class="fs-label-wrap"><div class="fs-label">'+this.settings.placeholder+'</div><span class="fs-arrow"></span></div>'),this.$select.before('<div class="fs-dropdown hidden"><div class="fs-options"></div></div>'),this.$select.addClass("hidden"),this.$wrap=this.$select.closest(".fs-wrap"),this.$wrap.data("id",window.fSelect.num_items),window.fSelect.num_items++,this.reload()},reload:function(){if(this.settings.showSearch){var e='<div class="fs-search"><input type="search" placeholder="'+this.settings.searchText+'" /></div>';this.$wrap.find(".fs-dropdown").prepend(e)}if(""!==this.settings.noResultsText){var t='<div class="fs-no-results hidden">'+this.settings.noResultsText+"</div>";this.$wrap.find(".fs-options").before(t)}this.idx=0,this.optgroup=0,this.selected=[].concat(this.$select.val());var i=this.buildOptions(this.$select);this.$wrap.find(".fs-options").html(i),this.reloadDropdownLabel()},destroy:function(){this.$wrap.find(".fs-label-wrap").remove(),this.$wrap.find(".fs-dropdown").remove(),this.$select.unwrap().removeClass("hidden")},buildOptions:function(e){var o=this,a="";return e.children().each(function(e,t){var i=f(t);if("optgroup"==i.prop("nodeName").toLowerCase())a+='<div class="fs-optgroup-label" data-group="'+o.optgroup+'">'+i.prop("label")+"</div>",a+=o.buildOptions(i),o.optgroup++;else{var s=i.prop("value");if(0<o.idx||""!=s||!o.settings.multiple){var n=i.is(":disabled")?" disabled":"",l='<div class="fs-option'+(-1<f.inArray(s,o.selected)?" selected":"")+n+(" g"+o.optgroup)+'" data-value="'+s+'" data-index="'+o.idx+'"><span class="fs-checkbox"><i></i></span><div class="fs-option-label">'+i.html()+"</div></div>";"function"==typeof o.settings.optionFormatter&&(l=o.settings.optionFormatter(l)),a+=l,o.idx++}}}),a},reloadDropdownLabel:function(){var e=this.settings,i=[];this.$wrap.find(".fs-option.selected").each(function(e,t){i.push(f(t).find(".fs-option-label").text())}),i=i.length<1?e.placeholder:i.length>e.numDisplayed?e.overflowText.replace("{n}",i.length):i.join(", "),this.$wrap.find(".fs-label").html(i),this.$wrap.toggleClass("fs-default",i===e.placeholder),this.$select.change()}},this.each(function(){var e=f(this).data("fSelect");e||(e=new i(this,t),f(this).data("fSelect",e)),"string"==typeof t&&e[t]()})},window.fSelect={num_items:0,active_id:null,active_el:null,last_choice:null,idx:-1},f(document).on("click",".fs-option:not(.hidden, .disabled)",function(e){var t=f(this).closest(".fs-wrap"),s=!1;if(!t.hasClass("fs-disabled")){if(t.hasClass("multiple")){var n=[];if(e.shiftKey&&null!=window.fSelect.last_choice){var l=parseInt(f(this).attr("data-index")),o=!f(this).hasClass("selected"),a=Math.min(window.fSelect.last_choice,l),d=Math.max(window.fSelect.last_choice,l);for(i=a;i<=d;i++)t.find(".fs-option[data-index="+i+"]").not(".hidden, .disabled").each(function(){f(this).toggleClass("selected",o)})}else window.fSelect.last_choice=parseInt(f(this).attr("data-index")),f(this).toggleClass("selected");t.find(".fs-option.selected").each(function(e,t){n.push(f(t).attr("data-value"))})}else{n=f(this).attr("data-value");t.find(".fs-option").removeClass("selected"),f(this).addClass("selected"),s=!0}t.find("select").val(n),t.find("select").fSelect("reloadDropdownLabel"),f(document).trigger("fs:changed",t),s&&c(t)}}),f(document).on("keyup",".fs-search input",function(e){if(40!=e.which){var t=f(this).closest(".fs-wrap"),i=f(this).val().replace(/[|\\{}()[\]^$+*?.]/g,"\\$&");t.find(".fs-option, .fs-optgroup-label").removeClass("hidden"),""!=i&&(t.find(".fs-option").each(function(){var e=new RegExp(i,"gi");null===f(this).find(".fs-option-label").text().match(e)&&f(this).addClass("hidden")}),t.find(".fs-optgroup-label").each(function(){var e=f(this).attr("data-group");f(this).closest(".fs-options").find(".fs-option.g"+e+":not(.hidden)").length<1&&f(this).addClass("hidden")})),l(t),n(t)}else f(this).blur()}),f(document).on("click",function(e){var t,i=f(e.target),s=i.closest(".fs-wrap");0<s.length?(s.data("id")!==window.fSelect.active_id&&c(),(i.hasClass("fs-label")||i.hasClass("fs-arrow"))&&(s.find(".fs-dropdown").hasClass("hidden")?(t=s,window.fSelect.active_el=t,window.fSelect.active_id=t.data("id"),window.fSelect.initial_values=t.find("select").val(),t.find(".fs-dropdown").removeClass("hidden"),t.addClass("fs-open"),l(t),n(t)):c(s))):c()}),f(document).on("keydown",function(e){var t=window.fSelect.active_el,i=f(e.target);if(i.hasClass("fs-wrap")){if(32==e.which||13==e.which)return e.preventDefault(),void i.find(".fs-label").trigger("click")}else if(0<i.closest(".fs-search").length){if(32==e.which)return}else if(null===t)return;if(38==e.which){e.preventDefault(),t.find(".fs-option.hl").removeClass("hl");var s=(n=t.find(".fs-option[data-index="+window.fSelect.idx+"]")).prevAll(".fs-option:not(.hidden, .disabled)");0<s.length?(window.fSelect.idx=parseInt(s.attr("data-index")),t.find(".fs-option[data-index="+window.fSelect.idx+"]").addClass("hl"),o(t)):(window.fSelect.idx=-1,t.find(".fs-search input").focus())}else if(40==e.which){var n;if(e.preventDefault(),(n=t.find(".fs-option[data-index="+window.fSelect.idx+"]")).length<1)var l=t.find(".fs-option:not(.hidden, .disabled):first");else l=n.nextAll(".fs-option:not(.hidden, .disabled)");0<l.length&&(window.fSelect.idx=parseInt(l.attr("data-index")),t.find(".fs-option.hl").removeClass("hl"),t.find(".fs-option[data-index="+window.fSelect.idx+"]").addClass("hl"),o(t))}else 32==e.which||13==e.which?(e.preventDefault(),t.find(".fs-option.hl").click()):27==e.which&&c(t)})}(jQuery);